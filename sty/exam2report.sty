\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{exam2report}[2023/08/11 Exam2Report]

\RequirePackage{lcrscommon}
\RequirePackage{tabularx}
\RequirePackage{tcolorbox}
\tcbuselibrary{skins}

% Setters for strings used in the exam report.
\lcrs@setter{submissioncaptionsingular}
\lcrs@setter{submissioncaptionplural}
\NewDocumentCommand{\submissioncaption}{ m m }{
    \submissioncaptionsingular{#1}
    \submissioncaptionplural{#2}
}

\lcrs@setter{taskcaptionsingular}
\lcrs@setter{taskcaptionplural}
\NewDocumentCommand{\taskcaption}{ m m }{
    \taskcaptionsingular{#1}
    \taskcaptionplural{#2}
}

% Language options
\DeclareOption{en}{
    \submissioncaption{Submission}{Submissions}
    \taskcaption{Task}{Tasks}
}
\DeclareOption{de}{
    \submissioncaption{Abgabe}{Abgaben}
    \taskcaption{Aufgabe}{Aufgaben}
}

% Programming language options
\lcrs@setter{examreport@srclanguage}
\lcrs@setter{examreport@srcfilesuffix}
\DeclareOption{go}{\examreport@srclanguage{go}\examreport@srcfilesuffix{go}}
\DeclareOption{java}{\examreport@srclanguage{java}\examreport@srcfilesuffix{java}}
\DeclareOption{tex}{\examreport@srclanguage{tex}\examreport@srcfilesuffix{tex}}

\lcrs@toggle{examreport@debug}
\disableexamreport@debug
\DeclareOption{debug}{\enableexamreport@debug}

\ExecuteOptions{en}
\ExecuteOptions{go}
\ProcessOptions\relax

\RequirePackage[\lcrs@examreport@srclanguage]{src2listing}

% A TColorBox for debug output.
\NewTColorBox{lcrs@debugbox}{}{
    on line,
    arc=0pt,outer arc=0pt,
    boxsep=0pt,left=1pt,right=1pt,top=2pt,bottom=2pt,
    boxrule=0pt,bottomrule=1pt,toprule=1pt,
    colback=red!5!white,colframe=red!75!black
}

\NewDocumentCommand{\lcrs@debug}{ m }{
    \ifexamreport@debug{
        \begin{lcrs@debugbox}
            #1
        \end{lcrs@debugbox}
    }{}
}

% Setters to use in an exam report.
\lcrs@setter{submissionsdir}[\textbf{<invalid>}]
\NewDocumentCommand{\addsubmissions}{ m }{
    % #1: submission names (comma-separated list)
    \forcsvlist{\listcsadd{lcrs@submissions}}{#1}
}
\csdef{lcrs@submissions}{}
\NewDocumentCommand{\addtasks}{ m }{
    % #1: task names (comma-separated list)
    \forcsvlist{\listcsadd{lcrs@tasks}}{#1}
}
\csdef{lcrs@tasks}{}

% Setters mainly for internal use.
\lcrs@setter{currentsubmission@basedir}[\textbf{<invalid>}]
\lcrs@setter{currentsubmission@name}[\textbf{<invalid>}]
\lcrs@setter{currentsubmission@title}[\textbf{<invalid>}]
\lcrs@setter{currentsubmission@dir}[\textbf{<invalid>}]
\lcrs@setter{currenttask@name}[\textbf{<invalid>}]
\lcrs@setter{currenttask@title}[\textbf{<invalid>}]
\lcrs@setter{currenttask@dir}[\textbf{<invalid>}]
\lcrs@setter{currenttask@file}[\textbf{<invalid>}]

% Debug output for setters.
\NewDocumentCommand{\lcrs@debug@values}{o}{
    % #1: optional caption
    \IfValueT{#1}{\ifexamreport@debug{\textbf{#1}}{}}

    \lcrs@debug{
        \begin{tabularx}{\textwidth}{ll}
            Current submission base dir & \lcrs@currentsubmission@basedir \\
            Current submission name & \lcrs@currentsubmission@name \\
            Current submission title & \lcrs@currentsubmission@title \\
            Current submission directory & \lcrs@currentsubmission@dir \\
            Current task name & \lcrs@currenttask@name \\
            Current task title & \lcrs@currenttask@title \\
            Current task directory & \lcrs@currenttask@dir \\
            Current task file & \lcrs@currenttask@file \\
        \end{tabularx}
    }
}

% Environment for a complete exam report.
% Mainly for internal use.
\NewDocumentEnvironment{examreport}{ O{\lcrs@submissionsdir} }{
    % #1: submission base directory (relative to the document root)
    \currentsubmission@basedir{#1}
    \lcrs@debug@values[Inside examreport environment:]
}{}

% Command to include a complete exam report.
\NewDocumentCommand{\insertexamreport}{ O{\lcrs@submissionsdir} O{} O{} }{
    % #1: submission base directory (relative to the document root)
    % #2: submission names for which to include reports (comma-separated list)
    % #3: task names for which to include reports (comma-separated list)
    \csdef{lcrs@local@wrapper}##1{\insertsubmissionreport{##1}[#3]}
    \begin{examreport}[#1]
        \forlistloop{\lcrs@local@wrapper}{\lcrs@submissions}
        \IfValueT{#2}{\forcsvlist{\lcrs@local@wrapper}{#2}}
    \end{examreport}
}

% Environment for a single submission report.
% Mainly for internal use.
\NewDocumentEnvironment{submissionreport}{ m }{
    % #1: submission name
    \currentsubmission@name{#1}
    \currentsubmission@title{\lcrs@submissioncaptionsingular : #1}
    \currentsubmission@dir{\lcrs@currentsubmission@basedir/#1}
    
    \lcrs@debug@values[Inside submissionreport environment:]

    \section*{\lcrs@currentsubmission@title}
}{}

% Command to include a single submission report.
\NewDocumentCommand{\insertsubmissionreport}{ m o }{
    % #1: submission name
    % #2: task names for which to include reports (comma-separated list)
    \begin{submissionreport}{#1}
        \forlistloop{\inserttaskreport}{\lcrs@tasks}
        \IfValueT{#2}{\forcsvlist{\inserttaskreport}{#2}}
    \end{submissionreport}
}

% Environment for a single task report.
% Mainly for internal use.
\NewDocumentEnvironment{taskreport}{ m }{
    % #1: task name
    \currenttask@name{#1}
    \currenttask@title{\lcrs@taskcaptionsingular : #1}
    \currenttask@dir{\lcrs@currentsubmission@dir/#1}
    \currenttask@file{\lcrs@currenttask@dir/#1.\lcrs@examreport@srcfilesuffix}
    
    \lcrs@debug@values[Inside taskreport environment:]

    \subsection*{\lcrs@currenttask@title}
}{}

% Command to include a single task report.
\NewDocumentCommand{\inserttaskreport}{ m }{
    % #1: task name
    \begin{taskreport}{#1}
        \inputsrcfile{\lcrs@currenttask@file}[BEGIN-END-1]
    \end{taskreport}
}

% TODOs:
% - [ ] Generalize debug commands to lcrscommon.sty.
% - [ ] Add error handling if no submissions, tasks, or submissionsdir are set.
%   - no submissionsdir: error or default value?
%   - no submissions or tasks: may be valid, but warning?
% - [ ] Add error handling if a submission or task is not found.
% - [ ] Add error handling if a submission or task is found multiple times.
% - [ ] Add style for report listings.
% - [ ] Restrict report listings to relevant parts of file.
%   - src2listing already allows this, but the markers in the source file must
%     be customizable from the report package.
% - [ ] Add possibility to evaluate grading comments.
% - [ ] Make line range in inserttaskreport customizable.
